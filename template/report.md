---
## Front matter
title: "Лабораторная работа №10"
subtitle: "Расширенные настройки SMTP-сервераФайл"
author: "Спелов Андрей Николаевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Целью данной работы является приобретение практических навыков по конфигурированию SMTP-сервера в части настройки аутентификации.

# Выполнение лабораторной работы

На виртуальной машине server войдём под нашим пользователем и откроем терминал. Перейдём в режим суперпользователя.В дополнительном терминале запустим мониторинг работы почтовой службы.(рис. [-@fig:001]).

![Запуск в дополнительном терминале мониторинга работы почтовой службы.](image/1.png){#fig:001 width=70%}

Добавим в список протоколов, с которыми может работать Dovecot, протокол LMTP. (рис. [-@fig:002]).

![Добавление в список протоколов, с которыми может работать Dovecot, протокола LMTP.](image/2.png){#fig:002 width=70%}

Настроим в Dovecot сервис lmtp для связи с Postfix. Для этого в файле /etc/dovecot/conf.d/10-master.conf замените определение сервиса lmtp на следующую запись из лабораторной работы. Эта запись определяет расположение файла с описанием прослушиваемого unix-сокета, а также задаёт права доступа к нему и определяет принадлежность к группе и пользователю postfix.(рис. [-@fig:003]).

![Настройка в Dovecot сервиса lmtp для связи с Postfix.](image/3.png){#fig:003 width=70%}

Переопределим в Postfix с помощью postconf передачу сообщений не на прямую, а через заданный unix-сокет(рис. [-@fig:004]).

![Переопределение в Postfix с помощью postconf передачи сообщений не на прямую, а через заданный unix-сокет.](image/4.png){#fig:004 width=70%}

В файле /etc/dovecot/conf.d/10-auth.conf зададим формат имени пользователя для аутентификации в форме логина пользователя без указания домена (рис. [-@fig:005]).

![Настройка в файле /etc/dovecot/conf.d/10-auth.conf формата имени пользователя для аутентификации в форме логина пользователя без указания домена.](image/5.png){#fig:005 width=70%}

Перезапустим Postfix и Dovecot (рис. [-@fig:006]).

![Перезапуск Postfix и Dovecot.](image/6.png){#fig:006 width=70%}

Из-под учётной записи своего пользователя отправим письмо с клиента (рис. [-@fig:007]).

![Отправка из-под учётной записи своего пользователя письма с клиента.](image/7.png){#fig:007 width=70%}

После чего посмотрим содержание логов при мониторинге почтовой службы(рис. [-@fig:008]).

![Просмотр содержания логов при мониторинге почтовой службы.](image/8.png){#fig:008 width=70%}

На сервере просмотрим почтовый ящик пользователя  (рис. [-@fig:009]).

![Просмотр на сервере почтового ящика пользователя.](image/9.png){#fig:009 width=70%}

В файле /etc/dovecot/conf.d/10-master.conf определим службу аутентификации пользователей(рис. [-@fig:010]).

![Определение в файле /etc/dovecot/conf.d/10-master.conf службы аутентификации пользователей.](image/10.png){#fig:010 width=70%}

Для Postfix зададим тип аутентификации SASL для smtpd и путь к соответствующему unix-сокету: 
postconf -e 'smtpd_sasl_type = dovecot' postconf -e 'smtpd_sasl_path = private/auth' 
Далее настроим Postfix для приёма почты из Интернета только для обслуживаемых нашим сервером пользователей или для произвольных пользователей локальной машины (имеется в виду локальных пользователейсервера), обеспечивая тем самым запрет на использование почтового сервера в качестве SMTP relay для спам-рассылок (порядок указания опций имеет значение): 
postconf -e 'smtpd_recipient_restrictions = reject_unknown_recipient_domain, permit_mynetworks, reject_non_fqdn_recipient, reject_unauth_destination, reject_unverified_recipient, permit' 
В настройках Postfix ограничим приём почты только локальным адресом SMTP-сервера сети(рис. [-@fig:011]).

![Настройка для Postfix типа аутентификации SASL для smtpd и пути к соответствующему unix-сокету, настройка Postfix для приёма почты из Интернета только для обслуживаемых нашим сервером пользователей или для произвольных пользователей локальной машины, ограничение в настройках Postfix приёма почты только локальным адресом SMTP-сервера сети.](image/11.png){#fig:011 width=70%}

Для проверки работы аутентификации временно запустим SMTP-сервер (порт 25) с возможностью аутентификации. Для этого в файле /etc/postfix/master.cf заменим строку(рис. [-@fig:012]).

![ Временный запуск для проверки работы аутентификации SMTP-сервера (порт 25) с возможностью аутентификации.](image/12.png){#fig:012 width=70%}

Затем перезапустим Postfix и Dovecot (рис. [-@fig:013]).

![Перезапуск Postfix и Dovecot.](image/13.png){#fig:013 width=70%}

На клиенте установим telnet(рис. [-@fig:014]).

![Установка на клиенте telnet.](image/14.png){#fig:014 width=70%}

На клиенте получим строку для аутентификации. В качестве результата получим строку для аутентификации в формате base64. После чего подключимся на клиенте к SMTP-серверу посредством telnet: 
telnet server.anspelov.net 25 
Теперь протестируем соединение, введя EHLO test и проверим авторизацию, задав: 
AUTH PLAIN <СДА> 
Завершим сессию telnet на клиенте (рис. [-@fig:015]).

![Получение на клиенте строки для аутентификации, подключение на клиенте к SMTP-серверу посредством telnet, тестирование соединения, проверка авторизации и завершение сессии telnet на клиенте.](image/15.png){#fig:015 width=70%}

Настроим на сервере TLS, воспользовавшись временным сертификатом Dovecot. Предварительно скопируем необходимые файлы сертификата и ключа из каталога /etc/pki/dovecot в каталог /etc/pki/tls/ в соответствующие подкаталоги (чтобы не было проблем с SELinux). Далее сконфигурируем Postfix, указав пути к сертификату и ключу, а также к каталогу для хранения TLS-сессий и уровень безопасности(рис. [-@fig:016]).

![Настройка на сервере TLS и предварительное копирование необходимых файлов сертификата и ключа из каталога /etc/pki/dovecot в каталог /etc/pki/tls/ в соответствующие подкаталоги. Настройка конфигурации Postfix.](image/16.png){#fig:016 width=70%}

Для того чтобы запустить SMTP-сервер на 587-м порту, в файле /etc/postfix/master.cf заменим строки(рис. [-@fig:017]).

![Замена строк в файле /etc/postfix/master.cf для того чтобы запустить SMTP-сервер на 587-м порту.](image/17.png){#fig:017 width=70%}

Настроим межсетевой экран, разрешив работать службе smtp-submission (рис. [-@fig:018]).

![Настройка межсетевого экрана, разрешив работать службе smtp-submission.](image/18.png){#fig:018 width=70%}

Перезапустим Postfix (рис. [-@fig:019]).

![Перезапуск Postfix.](image/19.png){#fig:019 width=70%}

На клиенте подключимся к SMTP-серверу через 587-й порт посредством openssl и протестируем подключение по telnet, проверим аутентификацию (рис. [-@fig:020]).

![Подключение на клиенте к SMTP-серверу через 587-й порт посредством openssl, тестирование подключения по telnet и проверка аутентификации.](image/20.png){#fig:020 width=70%}

Проверим корректность отправки почтовых сообщений с клиента посредством почтового клиента Evolution, предварительно скорректировав настройки учётной записи, а именно для SMTP-сервера укажем порт 587, STARTTLS и обычный пароль (рис. [-@fig:021]).

![Корректирование настроек почтового клиента Evolution.](image/21.png){#fig:021 width=70%}

На виртуальной машине server перейдём в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/. В соответствующие подкаталоги поместим конфигурационные файлы Dovecot и Postfix (рис. [-@fig:022]).

![Переход в каталог на виртуальной машине server для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/ и помещение в соответствующие подкаталоги конфигурационных файлов Dovecot и Postfix.](image/22.png){#fig:022 width=70%}

Внесём соответствующие изменения по расширенной конфигурации SMTP-сервера в файл /vagrant/provision/server/mail.sh  (рис. [-@fig:023]).

![Внесение соответствующих изменений по расширенной конфигурации SMTP-сервера в файл /vagrant/provision/server/mail.sh.](image/23.png){#fig:023 width=70%}

Внесём изменения в файл /vagrant/provision/client/mail.sh, добавив установку telnet (рис. [-@fig:024]).

![Внесение изменения в файл /vagrant/provision/client/mail.sh.](image/24.png){#fig:024 width=70%}

# Выводы

В ходе выполнения лабораторной работы были приобретены практические навыки по конфигурированию SMTP-сервера в части настройки аутентификации.

# Ответы на контрольные вопросы:

1.	Приведите пример задания формата аутентификации пользователя в Dovecot в форме логина с указанием домена.
Допустим, у нас есть почтовый ящик с адресом user@example.com. В конфигурационном файле Dovecot (/etc/dovecot/conf.d/10-auth.conf), мы можем указать формат аутентификации следующим образом:
auth_username_format = %Lu
В этом примере %Lu означает, что аутентификация будет проходить в формате "user" без учета регистра букв. Если вам нужно учитывать домен, вы можете использовать %n:
auth_username_format = %Ln
Таким образом, при вводе логина "user@example.com" пользователь будет аутентифицироваться с именем пользователя "user" и доменом "example.com".

2.	Какие функции выполняет почтовый Relay-сервер? – 
Пересылка почты: Relay-сервер принимает почтовые сообщения от клиентов и пересылает их к адресатам. Это особенно полезно,если у вас нет прямого доступа к серверу назначения или если вы хотите централизованно управлять отправкой почты.
Маршрутизация почты: Relay-сервер может определять наилучший маршрут для доставки почты на основе определенных правил и политик.
Блокировка спама: Некоторые Relay-серверы выполняют функции фильтрации спама, блокируя нежелательные сообщения до их отправки на сервер назначения.

3.	Какие угрозы безопасности могут возникнуть в случае настройки почтового сервера как Relay-сервера? – 
Открытый Relay: Если сервер настроен как открытый Relay, это может привести к злоупотреблению. Злоумышленники могут использовать сервер для отправки спама, что может повлечь за собой блокировку IP-адреса сервера или другие санкции.
Спуфинг: Атаки, связанные с подделкой отправителя (спуфинг), могут быть использованы для маскировки настоящего источника почты. Это может быть проблемой, если сервер Relay доверяет внешним источникам без должной аутентификации.
Отказ в обслуживании (DoS): Атаки типа DoS могут быть направлены на Relay-сервер, перегружая его запросами на пересылку почты и создавая неприемлемую загрузку.
 

# Список литературы{.unnumbered}

::: {#refs}
:::
