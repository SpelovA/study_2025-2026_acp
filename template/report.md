---
## Front matter
title: "Лабораторная работа №8"
subtitle: "Настройка SMTP-сервера"
author: "Спелов Андрей Николаевич"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Целью данной работы является приобретение практических навыков по установке и конфигурированию SMTPсервера.


# Выполнение лабораторной работы

На виртуальной машине server войдём под нашим пользователем и откроем терминал. Перейдём в режим суперпользователя: 
sudo -i 
И установим необходимые для работы пакеты: 
dnf -y install postfix 
dnf -y install s-nail(рис. [-@fig:001]).

![Открытие режима суперпользователя и установка пакета postfix.](image/1.png){#fig:001 width=70%}

Сконфигурируем межсетевой экран, разрешив работать службе протокола SMTP: 
firewall-cmd --add-service=smtp 
firewall-cmd --add-service=smtp --permanent 
firewall-cmd --list-services 
Восстановим контекст безопасности в SELinux: 
restorecon -vR /etc 
И запустим Postfix:
systemctl enable postfix 
systemctl start postfix (рис. [-@fig:002]).

![Конфигурирование межсетевого экрана, разрешив работать службе протокола SMTP. Восстановление контекста безопасности в SELinux и запуск Postfix.](image/2.png){#fig:002 width=70%}

Для просмотра списка текущих настроек Postfix введём: 
postconf 
Посмотрим текущее значение параметра myorigin: 
postconf myorigin 
И текущее значение параметра mydomain: 
postconf mydomain 
Указано mydomain = anspelov.net. Заменим значение параметра myorigin на значение параметра mydomain: 
postconf -e ‘myorigin = $mydomain’ 
Повторим команду postconf myorigin. Видим, что замена параметра была произведена (рис. [-@fig:003]).

![Просмотр списка текущих настроек Postfix, текущего значения параметра myorigin и текущего значения параметра mydomain. Замена значения параметра myorigin на значение параметра mydomain и выполнение проверки.](image/3.png){#fig:003 width=70%}

Теперь проверим корректность содержания конфигурационного файла main.cf: 
postfix check 
И перезагрузим конфигурационные файлы Postfix: 
systemctl reload postfix 
После чего просмотрим все параметры с значением, отличным от значения по умолчанию:
postconf -n(рис. [-@fig:004]).

![Проверка корректности содержания конфигурационного файла main.cf, перезагрузка конфигурационных файлов Postfix и просмотр всех параметров с значением, отличным от значения по умолчанию.](image/4.png){#fig:004 width=70%}

Зададим жёстко значение домена: 
postconf -e 'mydomain = = anspelov.net' 
Отключим IPv6 в списке разрешённых в работе Postfix протоколов и оставим только IPv4: 
postconf inet_protocols postconf -e 'inet_protocols = ipv4' 
Перезагрузим конфигурацию Postfix:
postfix check systemctl reload postfix (рис. [-@fig:005]).

![Задаём жёстко значение домена, отключение IPv6 в списке разрешённых в работе Postfix протоколов и оставление только IPv4, перезагрузка конфигурации Postfix.](image/5.png){#fig:005 width=70%}

На сервере под учётной записью пользователя отправим себе письмо, используя утилиту mail(рис. [-@fig:006]).

![Отправка на сервере под учётной записью пользователя себе письма, используя утилиту mail.](image/6.png){#fig:006 width=70%}

На втором терминале запустим мониторинг работы почтовой службы и посмотрим, что произошло с нашим сообщением (рис. [-@fig:007]).

![Запуск на втором терминале мониторинга работы почтовой службы и просмотр действий с сообщением.](image/7.png){#fig:007 width=70%}

Дополнительно посмотрим содержание каталога /var/spool/mail на предмет того, появился ли там каталог вашего пользователя
с отправленным письмом. Он появился(рис. [-@fig:008]).

![Смотрим каталог /var/spool/mail на наличие папки и письма](image/8.png){#fig:008 width=70%}

На виртуальной машине client войдём под нашим пользователем и откроем терминал. Далее перейдём в режим суперпользователя: 
sudo -i 
На клиенте установим необходимые для работы пакеты: 
dnf -y install postfix
dnf -y install s-nail  (рис. [-@fig:009]).

![Установка на клиенте необходимого пакета postfix.](image/9.png){#fig:009 width=70%}

Отключим IPv6 в списке разрешённых в работе Postfix протоколов и оставим только IPv4:
postconf inet_protocols 
postconf -e 'inet_protocols = ipv4' 
На клиенте запустим Postfix: 
systemctl enable postfix 
systemctl start postfix 
(рис. [-@fig:010]).

![Отключение IPv6 в списке разрешённых в работе Postfix протоколов (только IPv4), запуск на клиенте Postfix.](image/10.png){#fig:010 width=70%}

И под учётной записью пользователя аналогичным образом отправим себе второе письмо, используя утилиту mail(рис. [-@fig:011]).

![Отправка себе второго письма, используя утилиту mail.](image/11.png){#fig:011 width=70%}

Запустим мониторинг работы почтовой службы и посмотрим, что произошло с нашим сообщением(рис. [-@fig:012]).

![Запуск мониторинга работы почтовой службы.](image/12.png){#fig:012 width=70%}

На сервере в конфигурации Postfix посмотрим значения параметров сетевых интерфейсов inet_interfaces и сетевых адресов mynetworks: 
postconf inet_interfaces 
postconf mynetworks 
После чего разрешим Postfix прослушивать соединения не только с локального узла, но и с других интерфейсов сети: 
postconf -e 'inet_interfaces = all' 
Добавим адрес внутренней сети, разрешив таким образом пересылку сообщений между узлами сети: 
postconf -e 'mynetworks = 127.0.0.0/8, 192.168.0.0/16' 
Перезагрузим конфигурацию Postfix и перезапустим Postfix:
postfix check 
systemctl reload postfix 
systemctl stop postfix 
systemctl start postfix (рис. [-@fig:013]).

![В конфигурации Postfix на сервере просмотрим значения параметров сетевых интерфейсов inet_interfaces и сетевых адресов mynetworks, разрешение Postfix прослушивать соединения не только с локального узла, но и с других интерфейсов сети. Добавление адреса внутренней сети. Перезагрузка конфигурации Postfix и перезапуск Postfix.](image/13.png){#fig:013 width=70%}

Повторим отправку сообщения с клиента(рис. [-@fig:014]).

![Повторная отправка сообщения с клиента.](image/14.png){#fig:014 width=70%}

Дополнительно посмотрим содержание каталога /var/spool/mail на предмет того, появился ли там каталог вашего пользователя
с отправленным письмом. Письма нет(рис. [-@fig:015]).

![Смотрим каталог /var/spool/mail на наличие папки и письма](image/15.png){#fig:015 width=70%}

С клиента отправим письмо на свой доменный адрес(рис. [-@fig:016]).

![Отправка с клиента письма на свой доменный адрес.](image/16.png){#fig:016 width=70%}

Запустим мониторинг работы почтовой службы и посмотрим, что произошло с нашим сообщением:
tail -f /var/log/maillog(рис. [-@fig:017]).

![Запуск мониторинга работы почтовой службы.](image/17.png){#fig:017 width=70%}

Дополнительно посмотрим, какие сообщения ожидают в очереди на отправление(рис. [-@fig:018]).

![Просмотр сообщений, ожидающих в очереди на отправление.](image/18.png){#fig:018 width=70%}

Для настройки возможности отправки сообщений не на конкретный узел сети, а на доменный адрес пропишем MX-запись с указанием имени почтового сервера mail.anspelov.net в файле прямой DNS-зоны.(рис. [-@fig:019]).

![Запись MX-записи с указанием имени почтового сервера mail.anspelov.net в файле прямой DNS-зоны.](image/19.png){#fig:019 width=70%}

ля настройки возможности отправки сообщений не на конкретный узел сети, а на доменный адрес пропишем MX-запись с указанием имени почтового сервера в файле обратной DNS-зоны(рис. [-@fig:020]).

![Запись MX-записи с указанием имени почтового сервера mail.anspelov.net в файле обратной DNS-зоны.](image/20.png){#fig:020 width=70%}

В конфигурации Postfix добавим домен в список элементов сети, для которых данный сервер является конечной точкой доставки почты(рис. [-@fig:021]).

![Добавление в конфигурации Postfix домена в список элементов сети, для которых данный сервер является конечной точкой доставки почты.](image/21.png){#fig:021 width=70%}

Восстановим контекст безопасности в SELinux: 
restorecon -vR /etc 
restorecon -vR /var/named 
Далее перезапустим DNS: 
systemctl restart named 
Теперь попробуем отправить сообщения, находящиеся в очереди на отправление(рис. [-@fig:022]).

![Восстановление контекста безопасности в SELinux, перезапуск DNS и попытка отправки сообщений, находящихся в очереди на отправление.](image/22.png){#fig:022 width=70%}

Проверим отправку почты с клиента на доменный адрес(рис. [-@fig:023]).

![Проверка отправки почты с клиента на доменный адрес.](image/23.png){#fig:023 width=70%}

Запустим мониторинг работы почтовой службы и посмотрим, что произошло с нашим сообщением(рис. [-@fig:024]).

![Проверка отправки почты с клиента на доменный адрес.](image/24.png){#fig:024 width=70%}

На виртуальной машине server перейдём в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/. Заменим конфигурационные файлы DNS-сервера(рис. [-@fig:025]).

![Переход в каталог /vagrant/provision/server/ на виртуальной машине server для внесения изменений в настройки внутреннего окружения. Замена конфигурационных файлов DNS-сервера.](image/25.png){#fig:025 width=70%}

В каталоге /vagrant/provision/server создадим исполняемый файл mail.sh: 
cd /vagrant/provision/server 
touch mail.sh 
chmod +x mail.sh(рис. [-@fig:026]).

![Создание исполняемого файла mail.sh.](image/26.png){#fig:026 width=70%}

Открыв его на редактирование, пропишем в нём следующий скрипт(рис. [-@fig:027]).

![Открытие файла на редактирование и добавление скрипта.](image/27.png){#fig:027 width=70%}

На виртуальной машине client перейдём в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/client/: 
cd /vagrant/provision/client 
В этом каталоге создадим исполняемый файл mail.sh:
touch mail.sh 
chmod +x mail.sh(рис. [-@fig:028]).

![Переход в каталог /vagrant/provision/client/ на виртуальной машине client для внесения изменений в настройки внутреннего окружения. Cоздание исполняемого файла mail.sh.](image/28.png){#fig:028 width=70%}

Открыв его на редактирование, пропишем в нём следующий скрипт(рис. [-@fig:029]).

![Открытие файла на редактирование и добавление скрипта.](image/29.png){#fig:029 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины server в конфигурационном файле Vagrantfile добавим в разделе конфигурации для сервера(рис. [-@fig:030]).

![Добавление записи в Vagrantfile в разделе конфигураций для сервера.](image/30.png){#fig:030 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины client в конфигурационном файле Vagrantfile добавим в разделе конфигурации для клиента(рис. [-@fig:031]).

![Добавление записи в Vagrantfile в разделе конфигураций для клиента.](image/31.png){#fig:031 width=70%}

# Выводы

В ходе выполнения лабораторной работы были получены навыки по установке и конфигурированию SMTPсервера.

# Ответы на контрольные вопросы

1.	В каком каталоге и в каком файле следует смотреть конфигурацию Postfix? - Конфигурация Postfix обычно хранится в файле main.cf, а путь к этому файлу может различаться в разных системах. Однако, обычно он находится в каталоге /etc/postfix/. Таким образом, путь к файлу конфигурации будет /etc/postfix/main.cf. 

2.	Каким образом можно проверить корректность синтаксиса в конфигурационном файле Postfix? - Для проверки корректности синтаксиса в конфигурационном файле Postfix можно использовать команду postfix check. Например:
postfix check

3.	В каких параметрах конфигурации Postfix требуется внести изменения в значениях для настройки возможности отправки писем не на локальный хост, а на доменные адреса? - Для настройки возможности отправки писем не на локальный хост, а на доменные адреса, вы можете изменить параметры myhostname и mydomain в файле main.cf. Пример:
myhostname = yourhostname
mydomain = yourdomain.com
Также, убедитесь, что параметр mydestination не содержит локальных доменных имен, если вы хотите отправлять письма только на доменные адреса.

4.	Приведите примеры работы с утилитой mail по отправке письма, просмотру имеющихся писем, удалению письма. - Примеры работы с утилитой mail:
Отправка письма: echo "Текст письма" | mail -s "Тема" user@example.com
Просмотр имеющихся писем: mail
Удаление письма: mail -d номер_письма

5.	Приведите примеры работы с утилитой postqueue. Как посмотреть очередь сообщений? Как определить число сообщений в очереди? Как отправить все сообщения, находящиеся в очереди? Как удалить письмо из очереди? - Примеры работы с утилитой postqueue:
Просмотр очереди сообщений: postqueue -p
Определение числа сообщений в очереди: postqueue -p | grep -c "^[A-F0-9]"
Отправка всех сообщений из очереди: postqueue -f
Удаление письма из очереди (где ID_СООБЩЕНИЯ - идентификатор сообщения): postsuper -d ID_СООБЩЕНИЯ


# Список литературы{.unnumbered}

::: {#refs}
:::
